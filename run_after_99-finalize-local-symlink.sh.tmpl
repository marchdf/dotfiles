#!/usr/bin/env bash
{{- if .is_multiarch_home }}

# Finalize ~/.local symlink setup AFTER chezmoi has finished applying
# 1. First run: move ~/.local to ~/.local-${ARCH}, create symlink
# 2. Move chezmoi source to ~/.chezmoi-source (canonical, arch-independent)

ARCH=$(uname -m)
TARGET="${HOME}/.local-${ARCH}"
CHEZMOI_SOURCE="${HOME}/.chezmoi-source"
LOCAL_CHEZMOI="${HOME}/.local/share/chezmoi"

# First run: ~/.local is a real directory - move it
if [[ -d "${HOME}/.local" ]] && [[ ! -L "${HOME}/.local" ]]; then
    if [[ -d "${TARGET}" ]]; then
        # Merge into existing target
        cp -a "${HOME}/.local/." "${TARGET}/"
        rm -rf "${HOME}/.local"
    else
        mv "${HOME}/.local" "${TARGET}"
    fi
    ln -sfn "${TARGET}" "${HOME}/.local"
fi

# Move chezmoi source to canonical location (arch-independent)
# LOCAL_CHEZMOI now resolves through the symlink to ~/.local-${ARCH}/share/chezmoi
LOCAL_CHEZMOI_REAL="${TARGET}/share/chezmoi"
if [[ -d "${LOCAL_CHEZMOI_REAL}" ]] && [[ ! -L "${LOCAL_CHEZMOI_REAL}" ]]; then
    if [[ -d "${CHEZMOI_SOURCE}" ]]; then
        # Canonical source already exists - just replace with symlink
        rm -rf "${LOCAL_CHEZMOI_REAL}"
    else
        mv "${LOCAL_CHEZMOI_REAL}" "${CHEZMOI_SOURCE}"
    fi
    ln -sfn "${CHEZMOI_SOURCE}" "${LOCAL_CHEZMOI_REAL}"
fi

# Ensure chezmoi source symlink exists (for arch switch case where run_before already set it up)
if [[ ! -e "${LOCAL_CHEZMOI_REAL}" ]] && [[ -d "${CHEZMOI_SOURCE}" ]]; then
    mkdir -p "${TARGET}/share"
    ln -sfn "${CHEZMOI_SOURCE}" "${LOCAL_CHEZMOI_REAL}"
fi

{{- if and (ne .large_install_dir "") (ne .large_install_dir .chezmoi.homeDir) }}

# Same for large_install_dir on HPC systems
LARGE_TARGET="{{ .large_install_dir }}/.local-${ARCH}"
if [[ -d "{{ .large_install_dir }}/.local" ]] && [[ ! -L "{{ .large_install_dir }}/.local" ]]; then
    if [[ -d "${LARGE_TARGET}" ]]; then
        cp -a "{{ .large_install_dir }}/.local/." "${LARGE_TARGET}/"
        rm -rf "{{ .large_install_dir }}/.local"
    else
        mv "{{ .large_install_dir }}/.local" "${LARGE_TARGET}"
    fi
    ln -sfn "${LARGE_TARGET}" "{{ .large_install_dir }}/.local"
fi
{{- end }}
{{- end }}
