#!/usr/bin/env bash

if [[ ! -x "$(command -v pyenv)" ]]; then
    echo "Please install pyenv"
    exit 1
fi

usage() {
    echo "Usage: pyenv_python_install [-o] <version>"
    echo "  -o    Enable optimizations (--enable-optimizations --with-lto -mtune=native)"
    exit 1
}

OPTIMIZE=false

while getopts ":o" opt; do
    case ${opt} in
        o)
            OPTIMIZE=true
            ;;
        \?)
            usage
            ;;
    esac
done
shift $((OPTIND -1))

PYTHON_VERSION="${1}"
if [ -z "$PYTHON_VERSION" ]; then
    usage
fi

# Skip if already installed
if [[ -n "$(pyenv versions --bare | grep "^${PYTHON_VERSION}$")" ]]; then
    exit 0
fi

if [ "$OPTIMIZE" = true ]; then
    echo "Installing Python ${PYTHON_VERSION} with optimizations..."
    export PYTHON_CONFIGURE_OPTS="--enable-optimizations --with-lto"
    export PYTHON_CFLAGS="-mtune=native"
else
    echo "Installing Python ${PYTHON_VERSION}..."
fi

pyenv install -s "${PYTHON_VERSION}"
