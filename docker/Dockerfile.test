# Dockerfile for testing local chezmoi changes
# Minimal image - chezmoi apply happens at runtime, not build time
FROM ubuntu:24.04

# Avoid interactive prompts during build
ENV DEBIAN_FRONTEND=noninteractive

# Set default shell to bash for RUN commands
SHELL ["/bin/bash", "-c"]

# Create a non-root user for development
ARG USERNAME=marchdf
ARG USER_UID=1001
ARG USER_GID=$USER_UID

# Install bootstrap dependencies including build tools for Python
RUN apt-get update && apt-get install -y \
    curl \
    sudo \
    git \
    locales \
    hunspell-en-us \
    tzdata \
    zsh \
    tmux \
    file \
    wget \
    unzip \
    build-essential \
    libbz2-dev \
    libffi-dev \
    libgdbm-dev \
    liblzma-dev \
    libncurses5-dev \
    libncursesw5-dev \
    libnss3-dev \
    libreadline-dev \
    libsqlite3-dev \
    libssl-dev \
    tk-dev \
    uuid-dev \
    xz-utils \
    zlib1g-dev \
    libtag1-dev \
    libtagc0-dev \
    && locale-gen en_US.UTF-8 \
    && rm -rf /var/lib/apt/lists/*

# Set locale environment variables
ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8

# Create the user with sudo privileges (handle existing GID gracefully)
RUN if ! getent group $USER_GID > /dev/null 2>&1; then groupadd --gid $USER_GID $USERNAME; fi \
    && useradd --uid $USER_UID --gid $USER_GID -m $USERNAME -s /bin/zsh \
    && mkdir -p /etc/sudoers.d \
    && echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/$USERNAME \
    && chmod 0440 /etc/sudoers.d/$USERNAME

# Switch to the non-root user
USER $USERNAME
WORKDIR /home/$USERNAME

# Install chezmoi
RUN mkdir -p $HOME/.local/bin && \
    sh -c "$(curl -fsLS get.chezmoi.io)" -- -b $HOME/.local/bin

# Ensure local bin is in PATH
RUN echo 'export PATH="$HOME/.local/bin:$PATH"' >> $HOME/.profile
ENV PATH="/home/$USERNAME/.local/bin:${PATH}"

# Create directory structure for chezmoi source symlink
RUN mkdir -p $HOME/.local/share

# Copy entrypoint script (path relative to build context which is parent dir)
COPY --chmod=755 docker/entrypoint-test.sh /usr/local/bin/entrypoint.sh

# Set environment variables for interactive shell
ENV TERM=xterm-256color
ENV SHELL=/bin/zsh
ENV IN_DOCKER=true

# Use entrypoint to set up symlink at runtime
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]

# Set the default shell to zsh
CMD ["/bin/zsh", "-l"]
